% 
% \section{Solving the Stokes equations}
% --- Lid-driven cavity flow.
% 
% % <<<
% % Introduction 
% % <<<
% The Stokes equations \eqref{unsteady_stokes}, which are solved for a stable incompressible Navier-Stokes flow,
% assume the Reynolds number is $Re \ll 1$ and thus convective processes are neglible in comparison to viscous processes.
% We will begin with the steady-state form \eqref{steady_stokes}.
% Due to this simplification, the Steady stokes equations \eqref{steady_stokes}, repeated here:
% \begin{align*}
%     \mu\Delta u + \rho g - \nabla p = 0,\quad \nabla\cdot u = 0,
% \end{align*}
% form a constrained linear equation. As we saw in section \ref{pressure_derivation}, the pressure term $p$ is a Lagrange multiplier introduced
% with the constraint $\nabla\cdot u = 0$. We will begin by discretizing the \textit{unconstrained} steady Stokes equations,
% which are a vector Poisson equation:
% \begin{equation}\label{steady_stokes_unconstrained}
%     -\mu\Delta u = \rho g.
% \end{equation}
% % >>>
% \subsection{Discretizing the vector Poisson equation}\label{discretizing_vector_poisson}
% % <<<
% In principle we should keep the Stokes equation
% in integral form (using the conservative-form Cauchy momentum equation \eqref{cauchy_continuity_eulerian}), and continue as we did
% in section \ref{trial_function}. However,
% we will take a formal step to skip the reasoning of section \ref{trial_function}, typical of finite element method derivations.
% As we start with the \textit{differential} equation \eqref{steady_stokes_unconstrained}, we can introduce a trial space $\Psi$ and then ``weaken''
% the equation by integrating against $v \in \Psi$, and removing the Laplacian by integration by parts:
% \begin{equation}\label{steady_stokes_unconstrained_weak}
%     \int_\Omega -\mu\Delta u\cdot v\,dx = \int_\Omega \rho g\cdot v\,dx
%     \quad\equiv\quad
%     \int_\Omega -\mu\nabla u : \nabla v\,dx = \int_\Omega \rho g\cdot v\,dx.
% \end{equation}
% 
% Noting that the left-hand-side of \eqref{steady_stokes_unconstrained_weak} is a bilinear form in $u$ and $v$, and the right-hand-side
% is a linear functional in $\psi$, it is standard practice (ref) to write this kind of equation as
% \begin{equation}
%     a(u, v) = f(v).
% \end{equation}
% Our subsequent derivations are much the same as in \ref{discretizing_poisson}, simplified by our new notation.
% We can now approximate $u$ in the test space $\Phi$ as $\hat{u} = \sum_{i=1}^nu_i\phi_i$. By linearity we only need to compute
% trials over the basis trial functions $\psi_j$.
% We then have the linear system of equations
% \begin{equation}\label{elliptic_bilinear_form}
%     \sum_{i=1}^n u_i a\left(\phi_i, \psi_j\right) = f(\psi_j),\quad j=1,\cdots,n,
% \end{equation}
% which can be written in matrix form as
% \begin{equation}\label{elliptic_bilinear_form_matrix}
%     A\hat{u} = \begin{bmatrix}
%             a(\phi_1, \psi_1) & \cdots & a(\phi_1, \psi_n) \\
%             \vdots & & \vdots \\
%             a(\phi_n, \psi_1) & \cdots & a(\phi_n, \psi_n)
%             \end{bmatrix}
%     \begin{bmatrix} u_1 \\ u_2 \\ \vdots \\ u_{n-1} \\ u_n \end{bmatrix}
%     =
%     \begin{bmatrix} f(\psi_1) \\ f(\psi_2) \\ \vdots \\ f(\psi_{n-1}) \\ f(\psi_{n}) \end{bmatrix}
%     = \hat{f}.
% \end{equation}
% % The matrix $A$ is symmetric positive-definite, and we can therefore think of a solution to \eqref{elliptic_bilinear_form_matrix}
% % as as a minimizer of the scalar quadratic form
% % \begin{equation}\label{elliptic_quadratic_form}
% %     \hat{E}(\hat{u}) \coloneqq \frac{1}{2} \inner{\hat{u}, A\hat{u}} - \inner{\hat{u}, \hat{f}}.
% % \end{equation}
% % This is simply a discrete realisation of the fact that we can, as described in section \ref{pressure_derivation}, think
% % of a solution to the vector Poisson equation as a minimizer of the Dirichlet energy \eqref{steady_stokes_dirichlet_energy},
% % \begin{align*}
% %     E(u) \coloneqq \int_{\Omega} \frac{\mu}{2} \inner{\nabla u, \nabla u} - \rho g\cdot u \,dx.
% % \end{align*}
% We can solve \eqref{elliptic_bilinear_form_matrix} to get a velocity field $\sum_{i=1}^n u_i\phi_i$, although in general this will not satisfy $\nabla\cdot u = 0$.
% As some preliminary analysis, if $\Phi = \Psi$ and have the same basis functions, we have a symmetric-positive-definite system. This form of linear system is known to be stably solvable,
% for example by the conjugate gradient method.
% % >>>
% \subsection{Discretizing the steady Stokes equations}\label{discretizing_steady_stokes}
% % <<<
% As described in section \ref{pressure_derivation}, the pressure $p$ is a Lagrange multiplier that appears
% when solving the optimization problem \eqref{stokes_flow_optimization}:
% \begin{equation*}
% \begin{aligned}
% & \underset{u}{\text{minimize}}
% & & E(u) =  \frac{\mu}{2} \inner{\nabla u, \nabla u} - \inner{u, \rho g}\\
% & \text{subject to}
% & & \nabla\cdot u = 0.
% \end{aligned}
% \end{equation*}
% 
% \newcommand{\trialconstraint}{{\Psi_{\text{constraint}}}}
% \newcommand{\testpressure}{{\Phi_{\text{pressure}}}}
% As a first idea, we can introduce $p$ as a variable to solve for. Solving for the pressure (the ``dual variable'') simultaneously with the velocity
% (the ``primal variable'')
% is called a primal-dual method for the optimization \eqref{stokes_flow_optimization}, and the resulting finite element method is called \textit{mixed}.
% Pressure then needs to be discretized, so we introduce another test space $\testpressure$.
% To get a weak form of the steady Stokes equations \eqref{steady_stokes}, which are two equations including the constraint $\nabla\cdot u = 0$, we introduce
% another trial space $\trialconstraint$, whose functions will be integrated against $\nabla\cdot u$. The weak form is then
% \begin{equation*}
% \begin{split}
%     &\int_\om \left(\mu\Delta u + \rho g - \nabla p\right)\cdot v\,dx = 0,\\
%     &\int_\om \left(\nabla\cdot u\right) q\,dx = 0, \quad\text{where $v \in \Psi, q \in \trialconstraint$},
% \end{split}
% \end{equation*}
% which by integration by parts can be written as
% \begin{equation}\label{steady_stokes_weak}
% \begin{split}
%     &\int_\om -\mu\nabla u : \nabla v - \left(\nabla\cdot v\right)p\,dx = \int_\om \rho g\cdot v\,dx,\\
%     &\int_\om \left(\nabla\cdot u\right) q\,dx = 0, \quad\text{where $v \in \Psi, q \in \trialconstraint$}.
% \end{split}
% \end{equation}
% As in section \ref{discretizing_vector_poisson}, we introduce notation for the bilinear and linear forms in \eqref{steady_stokes_weak}:
% \begin{equation}
% \begin{split}
%     a(u, v) &\coloneqq \int_\om-\mu\nabla u : \nabla v\,dx,\quad\text{for $u \in \Phi, v \in \Psi$},\\
%     \hat{b}(p, v) &\coloneqq \int_\om-\left(\nabla\cdot v\right)p\,dx,\quad\text{for $p \in \testpressure, v \in \Psi$},\\
%     b(u, q) &\coloneqq \int_\om-\left(\nabla\cdot u\right)q\,dx,\quad\text{for $u \in \Phi, q \in \trialconstraint$},\\
%     f(v) &\coloneqq \int_\om \rho g\cdot v\,dx\quad\text{for $v \in \Psi$}.
% \end{split}
% \end{equation}
% Although they have the same form, $b$ and $\hat{b}$ are distinguished as they take inputs in different function spaces.
% We now have a simplified notation for the weak form \eqref{steady_stokes_weak},
% \begin{equation}\label{steady_stokes_weak_notation}
% \begin{split}
%     &a(u, v) + \hat{b}(p, v) = f(v),\\
%     &b(u, q) = 0, \quad\text{where $v \in \Psi, q \in \trialconstraint$}.
% \end{split}
% \end{equation}
% % Solving for $u^*$ in the equation $a(u^*, v) = f(v)$ is the standard vector Poisson equation, resulting in a symmetric-positive-definite
% % system when the test and trials spaces are discretized. We can imagine letting $p = 0$ and solving for $u^*$.
% % The first condition of \eqref{steady_stokes_weak_notation} will hold, but the second condition (does $b(u^*, q) = 0$?) generally will not.
% Working with discrete function spaces, we get a $2n\times 2n$ linear system in the unknowns $u_1,\cdots,u_n$ and $p_1,\cdots,p_n$,
% \begin{equation}
% \begin{split}
%     &\sum_{i=1}^n u_i a\left(\phi_i, \psi_j\right) + \sum_{i=1}^np_i\hat{b}\left(\phi^C_i, \psi_j\right) = f(\psi_j),\\
%     &\sum_{i=1}^nu_ib\left(\phi_i, \psi^C_j\right) = 0,\quad j=1,\cdots.n.
% \end{split}
% \end{equation}
% To emphasize the linear system structure of \eqref{steady_stokes_weak_notation}, the block matrix form is:
% \begin{equation}\label{steady_stokes_matrix}
% \def\arraystretch{1.5}
% \begin{split}
%     M\hat{x}
%     &= \begin{bmatrix}
%             A & \hat{B} \\
%             B & 0
%     \end{bmatrix}\hat{x} \\
%     &= \left[\begin{array}{@{}ccc|ccc@{}}
%             a(\phi_1, \psi_1) & \cdots & a(\phi_1, \psi_n)     & \hat{b}(\phi^C_1, \psi_1) & \cdots & \hat{b}(\phi^C_1, \psi_n) \\
%             \vdots & & \vdots                                  & \vdots & & \vdots \\
%             a(\phi_n, \psi_1) & \cdots & a(\phi_n, \psi_n)     & \hat{b}(\phi^Cn, \psi_1) & \cdots & \hat{b}(\phi^C_n, \psi_n) \\
%             \hline
%             b(\phi_1, \psi^C_1) & \cdots & b(\phi_1, \psi^C_n) & 0 &\cdots& 0      \\
%             \vdots & & \vdots \\                               & \vdots & & \vdots \\
%             b(\phi_n, \psi^C_1) & \cdots & b(\phi_n, \psi^C_n) & 0 &\cdots& 0       
%     \end{array}\right]
%     \left[\begin{array}{c} u_1 \\ \vdots \\ u_n \\ \hline p_1 \\ \vdots \\ p_n \end{array}\right]
%     =
%     \left[\begin{array}{c} f(\psi_1) \\ \vdots \\ f(\psi_{n}) \\ \hline 0 \\ \vdots \\ 0 \end{array}\right]
%     = \hat{b}.
% \end{split}
% \end{equation}
% \subsubsection{Is this method reasonable?}
% For the vector Poisson equation, letting $\Phi = \Psi$, we ended up with a symmetric-positive-definite system \eqref{elliptic_bilinear_form_matrix}, which is known to be stably solvable.
% We can ask how reasonable it is to solve \eqref{steady_stokes_matrix}, and what trial and test spaces we should use.
% In fact, in the problem \eqref{steady_stokes_weak_notation}, and more generally in a ``saddle point problem'', arising
% in Lagrange-multiplier methods for constrained PDEs, we should not choose just any test and trial spaces.
% The Ladyzhenskaya--Babu\v{s}ka--Brezzi condition, discussed later, enforces restrictions on choices that result in a stable method.
% We will until then continue with computations.
% 
% \subsubsection{Results and visualisation}
% \vskip 0.2in
% (results and visualisation)
% \vskip 0.2in
% % >>>
% \subsection{Discretizing the unsteady Stokes equations}\label{discretizing_unsteady_stokes}
% % <<<
% \newcommand{\uprev}{{u_{\text{prev}}}}
% The steady Stokes above are the stable state of the time-dependent Stokes flow,
% after the transient flow behaviour settles down. The unsteady Stokes equations \eqref{unsteady_stokes} are
% \begin{equation*}
%     \rho\Part{u}{t} = \mu\Delta u + \rho g - \nabla p, \quad \nabla\cdot u = 0.
% \end{equation*}
% These form an initial-boundary-value problem, and this will be our first attempt at discretizing a PDE in time.
% We could think of solving with the test and trial spaces over the domain $\Omega \times [0, T)$, but this is typically not done due to the memory costs,
% and different qualitative meaning of the time variable \cite{ham_fem}. Instead, we will use an implicit-Euler finite difference in time: 
% \begin{equation}\label{unsteady_stokes_implicit_euler}
%     \frac{\rho}{\Delta t} \left(u^{(n)} - u^{(n-1)}\right) = \mu\Delta u^{(n)} + \rho g - \nabla p^{(n)}, \quad \nabla\cdot u^{(n)} = 0,
% \end{equation}
% where $\Delta t$ is a fixed time step, and $u^{(n)}$ and $p^{(n)}$ is the solution at time $t_n = n\Delta t$. We can weaken each step
% \eqref{unsteady_stokes_implicit_euler}
% by integrating against trial functions $v \in \Psi$ and $q \in \trialconstraint$, performing integration by parts as in section \ref{discretizing_steady_stokes},
% and rearranging the knowns and unknowns. We can also let $u$ be $u^{(n)}$, $p$ be $p^{(n)}$, and $\uprev$ be $u^{(n-1)}$ in the above to simplify
% subsequent notation. The weak form of \eqref{unsteady_stokes_implicit_euler} is then:
% % \begin{equation}\label{unsteady_stokes_implicit_euler_weak}
% % \begin{split}
% %     \frac{\rho}{\Delta t} \int_\om \left(u^{(n)} - u^{(n-1)}\right)\cdot v\,dx
% %         &= \int_\om \mu\nabla u^{(n)}:\nabla v + \rho g\cdot v + \left(\nabla\cdot v\right) p^{(n)}\,dx,\\
% %     \quad \int_\om \left(\nabla\cdot u^{(n)}\right) q\,dx &= 0.
% % \end{split}
% % \end{equation}
% \begin{equation}\label{unsteady_stokes_implicit_euler_weak}
% \begin{split}
%     \int_\om \frac{\rho}{\Delta t} u\cdot v - \mu\nabla u:\nabla v - \left(\nabla\cdot v\right)p\,dx
%         &= \int_\om \frac{\rho}{\Delta t}\uprev\cdot v + \rho g \cdot v\,dx,\\
%     \quad \int_\om \left(\nabla\cdot u\right) q\,dx &= 0,
% \end{split}
% \end{equation}
% % and with the linear form definitions in section \ref{discretizing_steady_stokes} this is
% % \begin{equation}\label{unsteady_stokes_implicit_euler_weak_notation}
% % \begin{split}
% %     &\int_\om \frac{\rho}{\Delta t} u\cdot v \,dx + a(u, v) + \hat{b}(p, v) = \int_\om \frac{\rho}{\Delta t} \uprev\cdot v \,dx + f(v),\\
% %     &b(u, q) = 0, \quad\text{where $v \in \Psi, q \in \trialconstraint$}.
% % \end{split}
% % \end{equation}
% We can define the linear forms as
% \begin{equation}
% \begin{split}
%     a(u, v) &\coloneqq \int_\om\frac{\rho}{\Delta t}u\cdot v -\mu\nabla u : \nabla v\,dx,\quad\text{for $u \in \Phi, v \in \Psi$},\\
%     \hat{b}(p, v) &\coloneqq \int_\om-\left(\nabla\cdot v\right)p\,dx,\quad\text{for $p \in \testpressure, v \in \Psi$},\\
%     b(u, q) &\coloneqq \int_\om-\left(\nabla\cdot u\right)q\,dx,\quad\text{for $u \in \Phi, q \in \trialconstraint$},\\
%     f(v) &\coloneqq \int_\om \frac{\rho}{\Delta t}\uprev\cdot v + g\cdot v\,dx\quad\text{for $v \in \Psi$}
% \end{split}
% \end{equation}
% to reexpress \eqref{unsteady_stokes_implicit_euler_weak} in the notation
% \begin{equation}
% \begin{split}
%     &a(u, v) + \hat{b}(p, v) = f(v),\\
%     &b(u, q) = 0, \quad\text{where $v \in \Psi, q \in \trialconstraint$}.
% \end{split}
% \end{equation}
% This is the same structure as in the steady Stokes system \eqref{steady_stokes_weak_notation},
% and so the matrix block structure is the same as in \eqref{steady_stokes_matrix}. Therefore, every step we need to solve a linear system
% that is very similar to the steady Stokes problem. In fact this step can be thought of as successively introducing the momentum source $\rho g$
% (ignoring convection), while solving for the updated pressure needed to keep the fluid non-compressed.
% 
% \subsubsection{Discretizing the initial condition}
% We may have some analytically determined, or otherwise, initial velocity field $u$ with $\nabla\cdot u = 0$.
% We would like to form $u^{(0)}$ in order to start the iteration. The velocity $u$ should be projected in some way into the test space $\Psi$.
% Enforcing $u^{(0)}$ to give the same ``blurred average'' value when evaluated against a trial function,
% \begin{equation}\label{initial_velocity_projection}
%     \int_\om u^{(0)}\cdot v\,dx = \int_\om u \cdot v\,dx,\quad \forall v \in \Psi,
% \end{equation}
% gives a linear system
% \begin{equation}\label{initial_velocity_projection_linear_system}
%     \sum_{i=1}^n u^{(0)}_i \int_\om \phi_i \cdot \psi_j\,dx = \int_\om u\cdot \psi_j\,dx,
%     \quad j=1,\cdots,n.
% \end{equation}
% Solving this linear system for the $u^{(0)}_i$ gives $u^{(0)} = \sum_{i=1}^n u^{(0)}_i \phi_i$ as a projection of $u$ onto $\Phi$.
% This projection is orthogonal if $\Phi = \Psi$, and therefore could be considered the ``best'' such projection in the Euclidean norm.
% This is the standard Gramian matrix construction for projection in approximation theory \cite{approximation_theory}.
% 
% % >>>
% % >>>
% 
% \section{Solving non-linear equations}
% % <<<
% \subsection{A non-linear Poisson equation}
% \subsection{A non-linear heat equation}
% \subsection{The Burgers equation}
% % >>>
% 
% \section{Implementing finite element methods}
% % <<<
% \subsection{The Ciarlet definition of a finite element space}
% \cite{ciarlet}, \cite{ham_fem}, \cite{fenics_book}
% 
% 
% % Discuss Ciarlet definition, difference between FEM, spectral etc. FEM uses a domain partition to help in constructing the basis functions.
% 
% One great utility of the finite element method is that it is compatible with complex geometric domains and domain partitions.
% Some greater effort is needed to apply finite differences correctly across complex boundaries, and it is non-trivial to implement
% a varying resolution of the discretisation. In the finite element method, however, specifying the test and trial functions over
% a square grid is much the same as specifying them over, for example, a surface mesh of arbitrary topology. For modelling, for example,
% heat transfer in a complex solid, one can construct basis functions over a grid on the interior, and over cut-off boundary cells near the exterior.
% This is all in principle, of course, as one needs to
% \begin{enumerate}
%     \item Break the domain up into small pieces.
%     \item Construct the basis and trial functions over this domain partition (e.g. by finding polynomial coefficients).
%     \item Compute all inner products of test and trial functions, and their relevant derivatives, either numerically or analytically.
%     \item Solve possibly many huge sparse linear systems, while possibly changing the structure of the domain partition (requiring changes to the inner products).
% \end{enumerate}
% 
% Step (1) is already a field in itself, as evidenced by the open source tool TetGen \cite{tetgen}.
% TetGen is a small tool whose primary purpose is to perform \textit{constrained Delaunay tetrahedralization}, given a solid boundary and a point cloud on the interior.
% This constructs a valid tetrahedral partition intended for finite element solvers. The partition is efficiently created in a very robust manner in over 36k lines of C code. TetGen is part of the geometric backbone of many FEA tools (references).
% % >>>
